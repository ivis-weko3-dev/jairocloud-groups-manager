---
title: clients.auth
description: mAP Core Authorization Server の認証を行うクライアント機能を提供する。
---

## issue_client_credentials
SP のクライアント認証情報を mAP Core Authorization Server から発行・取得する機能を提供する。

#### 対応エンドポイント
**POST** [/oauth/sslauth/issue.php](../02.foundation/03.const.md#map_oauth_issue_endpoint)

#### シグネチャ
```python[auth.py]
def issue_client_credentials(entity_id: str, certs: SpCerts) -> ClientCredentials:
```

#### 依存するライブラリ
- **requests**： HTTP リクエストの送信に使用する。
- **flask**： リダイレクト URL の生成に使用する。
- **pydantic**： レスポンスのバリデーションおよびデシリアライズに使用。

#### 引数

| 名前                          | 型      | 説明                        |
| ----------------------------- | ------- | --------------------------- |
| entity_id                     | str     | SP エンティティ ID          |
| certs                         | SpCerts | SP の証明書情報オブジェクト |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;crt | str     | SP 証明書のファイルパス     |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;key | str     | SP 秘密鍵のファイルパス     |

- 第二引数 `certs` の型は `Protocol` で定義され、 `crt` および `key` 属性を持つオブジェクトを受け取る。
  これに合致するオブジェクトとして、 [`config.SP`](../02.foundation/02.config.md#spconfig) がある。

#### 戻り値

| 型                                                               | 説明                 |
| ---------------------------------------------------------------- | -------------------- |
| [ClientCredentials](../03.entities/07.auth.md#clientcredentials) | クライアント認証情報 |

#### エラー

| 型                                   | 説明                                            |
| ------------------------------------ | ----------------------------------------------- |
| requests.exceptions.RequestException | HTTP リクエストに失敗した場合。                 |
| requests.exceptions.HTTPError        | レスポンスのステータスコードが 200 以外の場合。 |

#### 処理内容
1. リダイレクト URL を生成する。エンドポイント [`api.callback.auth_code`](../04.api/06.callback.md#auth_code)
   に対応するスキーマとホスト名を含む完全な URL を `flask.url_for` を使用して取得する。
2. mAP Core Authorization Server に対してリクエストを送信する。
    - エンドポイント [`MAP_OAUTH_ISSUE_ENDPOINT`](../02.foundation/03.const.md#map_oauth_issue_endpoint) に対して、 POST リクエストを送信する。
    - クエリパラメータとして以下を付与する。
      | 名前         | 値                        |
      | ------------ | ------------------------- |
      | entityid     | 引数 `entity_id`          |
      | redirect_uri | ステップ 1 で生成した URL |
    - クライアント証明書として、引数 `certs` の `crt` および `key` で指定されたファイルを使用する。
    - サーバー設定値 [`config.MAP_CORE`](../02.foundation/02.config.md#mapcoreconfig) の `timeout` に従い、タイムアウトを設定する。
3. レスポンスのステータスコードが 200 以外の場合は `requests.exceptions.HTTPError` を送出する。
4. レスポンスボディを [`ClientCredentials`](../03.entities/07.auth.md#clientcredentials) モデルにデシリアライズして戻り値として返す。


## issue_oauth_token
認可コードを使用して SP のアクセストークンを mAP Core Authorization Server から発行・取得する機能を提供する。

#### 対応エンドポイント
**POST** [/oauth/token.php](../02.foundation/03.const.md#map_oauth_token_endpoint)

#### シグネチャ
```python[auth.py]
def issue_oauth_token(code: str, credentials: ClientCreds) -> OAuthToken:
```

#### 依存するライブラリ
- **requests**： HTTP リクエストの送信に使用する。
- **flask**： リダイレクト URL の生成に使用する。
- **pydantic**： レスポンスのバリデーションおよびデシリアライズに使用。

#### 引数

| 名前                                    | 型          | 説明                             |
| --------------------------------------- | ----------- | -------------------------------- |
| code                                    | str         | 認可コード                       |
| credentials                             | ClientCreds | クライアント認証情報オブジェクト |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;client_id     | str         | クライアント ID                  |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;client_secret | str         | クライアントシークレット         |

- 第二引数 `credentials` の型は `Protocol` で定義され、 `client_id` および `client_secret` 属性を持つオブジェクトを受け取る。
  これに合致するオブジェクトとして、 [`ClientCredentials`](../03.entities/07.auth.md#clientcredentials) がある。

#### 戻り値

| 型                                                 | 説明                           |
| -------------------------------------------------- | ------------------------------ |
| [OAuthToken](../03.entities/07.auth.md#oauthtoken) | 発行されたアクセストークン情報 |

#### エラー

| 型                                   | 説明                                            |
| ------------------------------------ | ----------------------------------------------- |
| requests.exceptions.RequestException | HTTP リクエストに失敗した場合。                 |
| requests.exceptions.HTTPError        | レスポンスのステータスコードが 200 以外の場合。 |

#### 処理内容
1. リダイレクト URL を生成する。エンドポイント [`api.callback.auth_code`](../04.api/06.callback.md#auth_code)
   に対応するスキーマとホスト名を含む完全な URL を `flask.url_for` を使用して取得する。
2. mAP Core Authorization Server に対してリクエストを送信する。
    - エンドポイント [`MAP_OAUTH_TOKEN_ENDPOINT`](../02.foundation/03.const.md#map_oauth_token_endpoint) に対して、 POST リクエストを送信する。
    - リクエストボディに以下のフォームデータを含める。
      | 名前         | 値                        |
      | ------------ | ------------------------- |
      | grant_type   | `"authorization_code"`    |
      | code         | 引数 `code`               |
      | redirect_uri | ステップ 1 で生成した URL |
    - ベーシック認証ヘッダに、引数 `credentials` の `client_id` および `client_secret` を使用する。
    - サーバー設定値 [`config.MAP_CORE`](../02.foundation/02.config.md#mapcoreconfig) の `timeout` に従い、タイムアウトを設定する。
3. レスポンスのステータスコードが 200 以外の場合は `requests.exceptions.HTTPError` を送出する。
4. レスポンスボディを [`OAuthToken`](../03.entities/07.auth.md#oauthtoken) モデルにデシリアライズして戻り値として返す。


## refresh_oauth_token
リフレッシュトークンを使用して SP のアクセストークンを mAP Core Authorization Server から更新・取得する機能を提供する。

#### 対応エンドポイント
**POST** [/oauth/token.php](../02.foundation/03.const.md#map_oauth_token_endpoint)

#### シグネチャ
```python[auth.py]
def refresh_oauth_token(refresh_token: str, credentials: ClientCreds) -> OAuthToken:
```

#### 依存するライブラリ
- **requests**： HTTP リクエストの送信に使用する。
- **pydantic**： レスポンスのバリデーションおよびデシリアライズに使用。

#### 引数

| 名前                                    | 型          | 説明                             |
| --------------------------------------- | ----------- | -------------------------------- |
| refresh_token                           | str         | リフレッシュトークン             |
| credentials                             | ClientCreds | クライアント認証情報オブジェクト |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;client_id     | str         | クライアント ID                  |
| &nbsp; ⤷&nbsp;&nbsp;&nbsp;client_secret | str         | クライアントシークレット         |

- 第二引数 `credentials` の型は `Protocol` で定義され、 `client_id` および `client_secret` 属性を持つオブジェクトを受け取る。
  これに合致するオブジェクトとして、 [`ClientCredentials`](../03.entities/07.auth.md#clientcredentials) がある。

#### 戻り値

| 型                                                 | 説明                           |
| -------------------------------------------------- | ------------------------------ |
| [OAuthToken](../03.entities/07.auth.md#oauthtoken) | 発行されたアクセストークン情報 |

#### エラー

| 型                                   | 説明                                            |
| ------------------------------------ | ----------------------------------------------- |
| requests.exceptions.RequestException | HTTP リクエストに失敗した場合。                 |
| requests.exceptions.HTTPError        | レスポンスのステータスコードが 200 以外の場合。 |

#### 処理内容
1. mAP Core Authorization Server に対してリクエストを送信する。
    - エンドポイント [`MAP_OAUTH_TOKEN_ENDPOINT`](../02.foundation/03.const.md#map_oauth_token_endpoint) に対して、 POST リクエストを送信する。
    - リクエストボディに以下のフォームデータを含める。
      | 名前          | 値                   |
      | ------------- | -------------------- |
      | grant_type    | `"refresh_token"`    |
      | refresh_token | 引数 `refresh_token` |
    - ベーシック認証ヘッダに、引数 `credentials` の `client_id` および `client_secret` を使用する。
    - サーバー設定値 [`config.MAP_CORE`](../02.foundation/02.config.md#mapcoreconfig) の `timeout` に従い、タイムアウトを設定する。
2. レスポンスのステータスコードが 200 以外の場合は `requests.exceptions.HTTPError` を送出する。
3. レスポンスボディを [`OAuthToken`](../03.entities/07.auth.md#oauthtoken) モデルにデシリアライズして戻り値として返す。
