---
title: api.bulk
description: クライアントサイドが使用するユーザー一括操作関連の API を提供する。
---

## bp
グループ管理関連の API を提供する Blueprint インスタンス。
名前は `"bulk"`、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/bulk"` に設定される。

#### シグネチャ
```python[bulk.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

## upload_file
インポートするファイルをサーバーにアップロードしバリデーションタスクを開始するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/upload-file")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
@with_files
def upload_file(body:ImportFiles) -> BulkBody:
```

#### エンドポイント
**POST** /api/bulk/upload_file

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。
- `@with_files`{lang=python}: `multipart/form-data`からファイルを取得、検証し、データクラスにパッケージ化して関数の引数に注入するデコレータ。

#### 引数
| 名前 | 型                                                             | 説明                                 |
| ---- | -------------------------------------------------------------- | ------------------------------------ |
| body | [`ImportFiles`](../03.entities/09.group-detail.md#importfiles) | ファイルデータを含むリクエストボディ |

#### 戻り値
| 型                                  | 説明                                       |
| ----------------------------------- | ------------------------------------------ |
| tuple\[BulkBody,Literal\[200]]      | タスクIDとファイルの識別子                 |
| tuple\[ErrorResponse,Literal\[400]] | ファイルに不備がある場合のエラーレスポンス |

#### 処理内容
1. リクエストボディからファイルを取得
2. UUIDv7でtemporary_idを作成しファイル名に付加
3. ファイルを仮アップロード用のディレクトリに保存
4. filesテーブルにid=temporary_id,file_path,file_contentを保存
5. [`services.bulk:delete_temporary_file`](../05.services/05.bulk.md#delete_temporary_file)をceleryのcountdownで呼び出す countdownの秒数はサーバー設定値とする
6. [`services.bulk:validate_import_data`](../05.services/05.bulk.md#validate_import_data)を呼び出しファイルのバリデーションを行うceleryのタスクを実行する
7.  タスクIDとtemporary_idをBulkBodyに入れ返却

### validate_status
バリデーションタスクの実行状況の取得エンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/validate/status/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def validate_status(task_id: str) -> tuple[BulkBody,Literal[200]] |tuple[ErrorResponse,Literal[500]]:
```

#### エンドポイント
**GET** /api/bulk/validate/status/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明     |
| ------- | --- | -------- |
| task_id | str | タスクID |

#### 戻り値
| 型                                  | 説明                            |
| ----------------------------------- | ------------------------------- |
| tuple\[BulkBody,Literal\[200]]      | タスクのstatus                  |
| tuple\[ErrorResponse,Literal\[404]] | task_idのタスクが存在しない場合 |
| tuple\[ErrorResponse,Literal\[500]] | Redis,DBの接続に失敗した場合    |

#### 処理内容
1. task_idをもとにタスクのstatusを取得
2. status取得時にredis.ConnectionErrorが発生した場合ErrorResponseとともに500を返却
3. statusが取得できなければErrorResponseとともに404を返却
4. statusを取得できればstatusをBulkBodyに入れて返却

## validate_result
インポートデータの検証結果を取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/validate/result/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def validate_result(task_id: str) -> ValidateSummary
```

#### エンドポイント
**GET** /api/bulk/validate/result/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明     |
| ------- | --- | -------- |
| task_id | str | タスクID |

#### 戻り値
| 型                                  | 説明                            |
| ----------------------------------- | ------------------------------- |
| ValidateSummary                     | データの検証結果                |
| tuple\[ErrorResponse,Literal\[404]] | task_idのタスクが存在しない場合 |
| tuple\[ErrorResponse,Literal\[500]] | Redis,DBの接続に失敗した場合    |

#### 処理内容
1. task_idをもとにタスクの実行結果から履歴IDを取得する
2. 履歴IDを引数に[`services.bulk:get_validate_result`](../05.services/05.bulk.md#get_validate_result)で検証結果を取得する
3. task_idのタスクが存在しない場合404とともにErrorResponseを返却
4. Redis,DBの接続に失敗した場合500とともにErrorResponseを返却
5. ValidateSummaryを返却する

## not_included_get
リポジトリに属するがファイルに含まれていないユーザーを取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.get("/not-included/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def not_included_get(task_id: str) -> list[UserDetail]:
```

#### エンドポイント
**GET** /api/bulk/not-included/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明     |
| ------- | --- | -------- |
| task_id | str | タスクID |

#### 戻り値
| 型                                  | 説明                                   |
| ----------------------------------- | -------------------------------------- |
| UsersResult                         | ファイルに含まれていないユーザーデータ |
| tuple\[ErrorResponse,Literal\[404]] | task_idのタスクが存在しない場合        |
| tuple\[ErrorResponse,Literal\[500]] | Redis,DBの接続に失敗した場合           |

#### 処理内容
1. task_idをもとにタスクの実行結果から履歴IDを取得する
2. 取得時にredis.ConnectionErrorが発生した場合ErrorResponseとともに500を返却
3. task_idのタスクが存在しない場合404とともにErrorResponseを返却
4. list\[UserDetail]をUsersResultに入れ返却

## execute
インポートタスクの実行をおこなうエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/execute/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def execute(body: ImportBody) -> BulkBody:
```

#### エンドポイント
**POST** /api/bulk/execute/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前 | 型         | 説明                               |
| ---- | ---------- | ---------------------------------- |
| body | ImportBody | インポートタスクのリクエストボディ |

#### 戻り値
| 型       | 説明     |
| -------- | -------- |
| BulkBody | タスクID |

#### 処理内容
1. [`service.bulk:update_users`](../05.services/05.bulk.md#update_users)をceleryのタスクで実行する
2. task_idをBulkBodyに入れて返却

## execute_status
- インポートタスクの実行状況の取得エンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/upload-file/<string:task_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def execute_status(task_id: str) -> tuple[BulkBody,Literal[200]]|tuple[ErrorResponse,Literal[200]]
```
#### エンドポイント
**GET** /api/bulk/execute/status/<task_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前    | 型  | 説明     |
| ------- | --- | -------- |
| task_id | str | タスクID |

#### 戻り値
| 型                                  | 説明                            |
| ----------------------------------- | ------------------------------- |
| tuple\[BulkBody,Literal\[200]]      | タスクのstatus                  |
| tuple\[ErrorResponse,Literal\[404]] | task_idのタスクが存在しない場合 |
| tuple\[ErrorResponse,Literal\[500]] | Redis接続に失敗した場合         |

#### 処理内容
1. task_idをもとにタスクのstatusを取得
2. status取得時にredis.ConnectionErrorが発生した場合ErrorResponseとともに500を返却
3. task_idのタスクが存在しない場合404とともにErrorResponseを返却
4. statusを取得できればstatusをBulkBodyに入れて返却

## result
- インポート情報を取得するエンドポイント

#### シグネチャ
```python[bulk.py]
@bp.post("/result/<string:history_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def result(history_id: pydantic.UUID7) -> ResultSummary:
```

#### エンドポイント
**GET** /api/bulk/result/<history_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数
| 名前       | 型             | 説明                 |
| ---------- | -------------- | -------------------- |
| history_id | pydantic.UUID7 | アップロード履歴のid |

#### 戻り値
| 型            | 説明                 |
| ------------- | -------------------- |
| ResultSummary | インポート結果データ |

#### 処理内容
1. services.bulk:get_import_resultでデータを取得する
5. 例外が発生した場合ErrorResponseを返却
