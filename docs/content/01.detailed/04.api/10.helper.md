---
title: api.helper
description: コントローラー層で使用するデコレータを定義する
---

## roles_required
ユーザーが権限を持っているか検証するデコレータ

#### シグネチャ
```python[helper.py]
def roles_required(*roles: str) -> Callable[[Callable[P, R]], Callable[P, R]]:
```

#### 引数
| 名前   | 型  | 説明                                   |
| ------ | --- | -------------------------------------- |
| *roles | str | アクセスを許可するロール (可変長引数 ) |

#### 戻り値
| 型            | 説明                               |
| ------------- | ---------------------------------- |
| Literal\[403] | ユーザーに要求された権限がない場合 |

#### 処理内容
1. current_user.is_member_of を引数に [`services.permissions:extract_group_ids`](../05.services/08.permissions.md#extract_group_ids) でグループ ID を取得する。
2. `services.utils.affiliations:detect_affiliations`を呼び出しロールを取得する。
3. 引数が含まれていなければ 403 を返す。

## refresh_session
ログインセッションの TTL を更新する。

#### シグネチャ
```
def refresh_session():
```

#### 処理内容
1. flask のログインセッションから session_id を取得する。
2. session_id を引数に[`build_account_store_key](#build_account_store_key)を呼び出しアカウントストアのキーを作成する。
3. キーをもとにセッション情報を取り出し上限を超えていないことを確認する。
4. アカウントストアの TTL を更新する。

#### 備考
Blueprint に対し before_request で登録しておくことで API が呼び出されるたびに処理が行われる。

## build_account_store_key
セッション ID をもとにセッション情報を取得するキーを作成する。

#### シグネチャ
```
def build_account_store_key(session_id:str) -> str:
```

#### 処理内容
1. 設定値から prefix を取得し session_id とともにキーを作成する。
2. キーを戻り値として返す。
