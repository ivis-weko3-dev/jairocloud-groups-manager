---
title: api.users
description: クライアントサイドが使用するユーザー管理関連の API のコントローラ機能を提供する。  
---

## bp
ユーザー管理関連の API を提供する Blueprint インスタンス。
名前は `"users"` 、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/users"` に設定される。

#### シグネチャ
```python[users.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。


## get
ユーザーの取得・検索の機能を提供するコントローラ。

#### シグネチャ
```python[users.py]
@bp.get("/")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def get(query: UsersQuery) -> tuple[UsersResult | ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/users

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ログインユーザーの認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前  | 型         | 説明                                   |
| ----- | ---------- | -------------------------------------- |
| query | UsersQuery | ユーザー検索条件を含むクエリパラメータ |

#### 戻り値

| 型                                   | 説明                                                           |
| ------------------------------------ | -------------------------------------------------------------- |
| tuple\[UsersResult, Literal\[200]]   | ユーザーの検索結果を含むレスポンス                             |
| tuple\[ErrorResponse, Literal\[403]] | ロールの権限を越える検索条件が指定された場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[500]] | 検索処理に失敗した場合のエラーレスポンス                       |

#### 処理内容

1. リクエストコンテキストからログインユーザー情報を取得する。
2. `build_user_search_criteria` を呼び出し、引数 `query` とログインユーザーのロールに基づいた `UserSearchCriteria` オブジェクトを構築する。  
   検索条件にロールの権限を越える条件が含まれている場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 403 とともに返す。
3. `UserSearchCriteria` オブジェクトをもとに、 `services.users:search` を呼び出し、ユーザーの検索結果を取得する。
4. 検索処理に失敗した場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 検索結果を `UsersResult` オブジェクトに格納し、ステータスコード 200 とともに返す。


## post
ユーザーの作成の機能を提供するコントローラ。

#### シグネチャ
```python[users.py]
@bp.post("/")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def post(body: UserDetail) -> tuple[UserDetail, int, dict[str, str]] | tuple[ErrorResponse, int]:
```

#### エンドポイント
**POST** /api/users

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： ユーザー認証を行う。

#### デコレータ
- `@bp.post`{lang=python}： POST リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前 | 型         | 説明                                       |
| ---- | ---------- | ------------------------------------------ |
| body | UserDetail | 作成するユーザー情報を含むリクエストボディ |

#### 戻り値

| 型                                                 | 説明                                                           |
| -------------------------------------------------- | -------------------------------------------------------------- |
| tuple\[UserDetail, Literal\[201], dict\[str, str]] | 作成されたユーザー情報と Location ヘッダーを含むレスポンス     |
| tuple\[ErrorResponse, Literal\[403]]               | ユーザー作成権限がない場合のエラーレスポンス                   |
| tuple\[ErrorResponse, Literal\[409]]               | ユーザー ID または ePPN がすでに存在する場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[500]]               | ユーザー作成処理に失敗した場合のエラーレスポンス               |

#### 処理内容

1. リクエストコンテキストからログインユーザー情報を取得する。
2. ユーザー ID 、ePPN がすでに存在するかを確認する。  
   存在する場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 409 とともに返す。
3. ログインユーザーのロールをもとに、ユーザーを作成できるかを確認する。
   - システム管理者の場合、すべてのユーザーを作成できる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するユーザーのみ作成できる。  
     すべての所属リポジトリがログインユーザーが管理するリポジトリに含まれていなければ、ステータスコード 403 とともに返す。
4. 引数 `body` をもとに、 `services.users:create` を呼び出し、ユーザーを作成する。
5. ユーザー作成処理に失敗した場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
6. 作成されたユーザー情報を `UserDetail` オブジェクトとして、ステータスコード 201 および `Location` ヘッダーとともに返す。  
  `Location` ヘッダーには作成されたユーザーの情報取得 API の絶対 URL を設定する。


## id_get
ユーザーの情報取得の機能を提供するコントローラ。

#### シグネチャ
```python[users.py]
@bp.get("/<string:user_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def id_get(user_id: str) -> tuple[UserDetail | ErrorResponse, int]:
```

#### エンドポイント
**GET** /api/users/<user_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： ユーザー認証を行う。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前    | 型  | 説明        |
| ------- | --- | ----------- |
| user_id | str | ユーザー ID |

#### 戻り値

| 型                                   | 説明                                                     |
| ------------------------------------ | -------------------------------------------------------- |
| tuple\[UserDetail, Literal\[200]]    | ユーザー情報を含むレスポンス                             |
| tuple\[ErrorResponse, Literal\[403]] | ユーザー情報へのアクセス権限がない場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[404]] | ユーザーが存在しない場合のエラーレスポンス               |
| tuple\[ErrorResponse, Literal\[500]] | ユーザー情報の取得に失敗した場合のエラーレスポンス       |

#### 処理内容
1. リクエストコンテキストからログインユーザー情報を取得する。
2. 引数 `user_id` をもとに、 `services.users:get_by_id` を呼び出し、ユーザー情報を取得する。
3. ユーザーが存在しなかった場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
4. 取得に失敗した場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
5. 取得されたユーザー情報とログインユーザーのロールに基づき、ユーザー情報へのアクセスできるかを確認する。
   - システム管理者の場合、すべてのユーザー情報にアクセスできる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するユーザーにのみアクセスできる。  
     所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 403 とともに返す。
6. 取得したユーザー情報を `UserDetail` オブジェクトとして、ステータスコード 200 とともに返す。


## id_put
ユーザーの更新の機能を提供するコントローラ。

#### シグネチャ
```python[users.py]
@bp.put("/<string:user_id>")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def id_put(user_id: str, body: UserDetail) -> tuple[UserDetail | ErrorResponse, int]:
```

#### エンドポイント
**PUT** /api/users/<user_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。
- **Flask-Login**： ユーザー認証を行う。

#### デコレータ
- `@bp.put`{lang=python}： PUT リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」または「リポジトリ管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前    | 型         | 説明                                       |
| ------- | ---------- | ------------------------------------------ |
| user_id | str        | ユーザー ID                                |
| body    | UserDetail | 更新するユーザー情報を含むリクエストボディ |

#### 戻り値

| 型                                   | 説明                                                   |
| ------------------------------------ | ------------------------------------------------------ |
| tuple\[UserDetail, Literal\[200]]    | 更新されたユーザー情報を含むレスポンス                 |
| tuple\[ErrorResponse, Literal\[403]] | ユーザー情報を更新する権限がない場合のエラーレスポンス |
| tuple\[ErrorResponse, Literal\[404]] | ユーザーが存在しない場合のエラーレスポンス             |
| tuple\[ErrorResponse, Literal\[409]] | 更新内容に競合があった場合のエラーレスポンス           |
| tuple\[ErrorResponse, Literal\[500]] | ユーザー更新処理に失敗した場合のエラーレスポンス       |

#### 処理内容
1. リクエストコンテキストからログインユーザー情報を取得する。
2. 引数 `body` とログインユーザーのロールをもとに、ユーザーを更新できるかを確認する。
   - システム管理者の場合、すべてのユーザーを更新できる。
   - リポジトリ管理者の場合、ログインユーザーが管理するリポジトリに所属するユーザーのみ更新できる。  
     すべての所属リポジトリがログインユーザーの管理するリポジトリに含まれていない場合、ステータスコード 403 とともに返す。
3. 引数 `body` をもとに、 `services.users:update` を呼び出し、ユーザー情報を更新する。
4. ユーザーが存在しない場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
5. 更新内容に競合があった場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 409 とともに返す。
6. ユーザー更新処理に失敗した場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
7. 更新されたユーザー情報を `UserDetail` オブジェクトとして、ステータスコード 200 とともに返す。


## ~~id_delete~~
ユーザーの削除の機能を提供するコントローラ。実装予定なし。

#### シグネチャ
```python[users.py]
@bp.delete("/<string:user_id>")
@login_required
@roles_required("system_admin")
@validate()
def id_delete(user_id: str) -> tuple[ Literal[""] | ErrorResponse, int]:
```

#### エンドポイント
**DELETE** /api/users/<user_id>

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。
- **Flask-Login**： ユーザー認証を行う。
- **Flask-Pydantic**： リクエストとレスポンスのバリデーション、シリアライズ・デシリアライズを行う。

#### デコレータ
- `@bp.delete`{lang=python}： DELETE リクエストを処理するエンドポイントを定義する。
- `@login_required`{lang=python}： ログインを要求する。
- `@roles_required`{lang=python}： ログインユーザーに「システム管理者」のロールを要求する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前    | 型  | 説明        |
| ------- | --- | ----------- |
| user_id | str | ユーザー ID |

#### 戻り値

| 型                                   | 説明                                             |
| ------------------------------------ | ------------------------------------------------ |
| tuple\[Literal\[""\], Literal\[204]] | 正常にユーザーが削除された場合のレスポンス       |
| tuple\[ErrorResponse, Literal\[404]] | ユーザーが存在しない場合のエラーレスポンス       |
| tuple\[ErrorResponse, Literal\[500]] | ユーザー削除処理に失敗した場合のエラーレスポンス |

#### 処理内容
1. 引数 `user_id` をもとに、 `services.users:delete` を呼び出し、ユーザーを削除する。
2. ユーザーが存在しなかった場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 404 とともに返す。
3. ユーザー削除処理に失敗した場合、 `ErrorResponse` オブジェクトを作成し、ステータスコード 500 とともに返す。
4. 正常にユーザーが削除された場合、空文字列とステータスコード 204 とともに返す。

## filter_options
フィルター選択肢の取得を提供するコントローラ。

#### シグネチャ
```python[users.py]
@bp.get("/filter-options")
@login_required
@roles_required("system_admin", "repository_admin")
@validate()
def filter_options() -> FilterOption:
```

#### エンドポイント
**GET** /api/users/filter-options

#### 戻り値

| 型           | 説明                           |
| ------------ | ------------------------------ |
| FilterOption | ユーザーのフィルターオプション |

#### 処理内容
1. current_user.is_member_of でis_member_of を取得
2. [`service.users:get_filter_options`](../05.services/04.users.md#get_filter_options) でフィルターオプションを取得
3. FilterOption を返却する
