---
title: api.callback
description: コールバックでアクセスされる API エンドポイントを提供する。
---

## bp
コールバック関連の API を提供する Blueprint インスタンス。
名前は `"callback"` 、URL プレフィックスは [`router:create_api_blueprint`](./02.router.md#create_api_blueprint) によって `"/api/callback"` に設定される。

#### シグネチャ
```python[callback.py]
bp: Blueprint
```

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。


## auth_code
コールバックで認可コードを受け取るエンドポイントを提供するコントローラ。

#### シグネチャ
```python[callback.py]
@bp.get("/auth-code")
@validate()
def auth_code(query: OAuthTokenQuery) -> werkzeug.wrappers.Response:
```

#### エンドポイント
**GET** /api/callback/auth-code

#### 依存するライブラリ
- **Flask**： Blueprint を使用する。

#### デコレータ
- `@bp.get`{lang=python}： GET リクエストを処理するエンドポイントを定義する。
- `@validate`{lang=python}： モデルクラスを使用してリクエストとレスポンスのバリデーションを行う。

#### 引数

| 名前  | 型                                                | 説明                             |
| ----- | ------------------------------------------------- | -------------------------------- |
| query | [OAuthTokenQuery](./07.schema.md#oauthtokenquery) | 認可コードを含むクエリパラメータ |

#### 戻り値

| 型                         | 説明                   |
| -------------------------- | ---------------------- |
| werkzeug.wrappers.Response | リダイレクトレスポンス |

#### 処理内容
1. [`service.token.issue_oauth_token`](./01.token.md#issue_oauth_token) を呼び出し、引数 `query` に含まれる認可コード `code` を使用してアクセストークンの発行を試みる。
2. [`DatabaseError`](../02.foundation/07.exc.md#databaseerror) 、 [`CredentialsError`](../02.foundation/07.exc.md#credentialserror) や [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror) が送出された場合は、エラーログを記録する。
3. アクセストークンの発行の成否に合わせたメッセージを含むリダイレクトレスポンスを生成して戻り値として返す。
