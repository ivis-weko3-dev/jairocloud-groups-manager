---
title: services.bulk
description: 当システムのリソースをまたぐ一括処理に関するビジネスロジックを提供する。
---

## save_file
ファイルを保存する

#### シグネチャ
```python[bulk.py]
def save_file(repository_id:str, location:str) -> pydantic.UUID7:
```

#### 引数
| 名前          | 型  | 説明                                 |
| ------------- | --- | ------------------------------------ |
| temporary_id  | str | 仮アップロードされたファイルの識別子 |
| repository_id | str | 選択されたリポジトリのID             |

#### 戻り値
| 型             | 説明       |
| -------------- | ---------- |
| pydantic.UUID7 | ファイルID |

#### 処理内容
1. temporary_idをもとにファイルを取得
2. ファイルが存在しない場合，形式がcsv,tsv,excelと異なる場合，ファイルサイズが上限以上の場合はResourceInvalidを送出
3. UUIDv7のファイルIDを作成する
4. ファイルID 上4桁を2文字区切りで区切ったパスをファイルパスとしてファイルを保存する
5. DBのfilesテーブルにid , file_path,file_content["repositories"]を保存する
6. [delete_temporary_file](#delete_temporary_file)でtemporary_idのファイルを削除する
7. ファイルIDを返却する
8.  例外が発生した場合[delete_temporary_file](#delete_temporary_file)でtemporary_idのファイルを削除したのちその例外をraiseする

## validate_import_data
アップロードされたデータの検証をおこなうceleryのタスク

#### シグネチャ
```python[bulk.py]
def validate_import_data(temporary_id:pydantic.UUID7):
```

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前         | 型             | 説明                                 |
| ------------ | -------------- | ------------------------------------ |
| temporary_id | pydantic.UUID7 | 仮アップロードされたファイルの識別子 |

#### 戻り値
| 型             | 説明                               |
| -------------- | ---------------------------------- |
| pydantic.UUID7 | インポート結果を保存したデータのID |
#### 処理内容
1. temporary_idをもとにfilesテーブルからfile_path，file_contentを取得
2. fole_contentからrepository_idを取り出す
3. repository_idを引数に[`services.repositories:get_repository_member`](../05.services/02.repositories.md#get_repository_member)で`group_ids`と`user_ids`を取得
4.  [`UnexpectedResponseError`](../02.foundation/07.exc.md#unexpectedresponseerror)が発生した場合リトライ
5.  `check_result: list[CheckResult] = []`とする
6. [`read_file`](#read_file)を実行しimport_dataを取得
7. import_dataに使われている文字の種類や文字数が問題ないか，groupが`group_ids`に含まれているか確認する
8. 問題があればstatusをerror,messageにエラー内容，bulk_operationをNoneで[`CheckResult`]として`check_result`に追加
9.  import_dataのidが空白または`user_ids`に含まれていない場合statusをcreate,messageをNone，bulk_operationをmethod="POST",path=MAP_USERS_ENDPOINT,data=import_data[i]で[`CheckResult`]オブジェクトを作成し`check_result`に追加
10. 両方に存在する場合update_listに追加
11. import_dataすべてに対し繰り返す
12. update_listのidで[`client.users.get_by_id`](../06.clients/04.users.md#get_by_id)
13. import_dataと比較して変更があればstatusをupdate，差分からbulk_operationを作成し,messageに変更される内容を入れて[`CheckResult`]とする
14. [API経由で変更不能な属性](#api経由で変更不能な属性)が変更されている場合はstatusをerror,messageにエラー内容，bulk_operationをNoneで[`CheckResult`]オブジェクトを作成し`check_result`に追加
15. 変更がなければstatusをskip，bulk_operationをNone,messageをNoneとして[`CheckResult`]オブジェクトを作成し`check_result`に追加
16. check_resultを用いてValidateSummaryを作成する
17. `user_ids`に含まれているがimport_dataに含まれていないidのユーザー情報を取得しstatusをskip,bulk_operationをNoneとしてlist[`CheckResult`]オブジェクトを作成する
18. list[`CheckResult`]をJSONに変形しnot_includeとする
19. UUIDv7の履歴IDを作成する
20. 履歴IDとファイルID，operator,public=True,status="c",result=ValidateSummary.model_dump,not_includeでupload_historyテーブルに保存する
21. 履歴IDを返却

#### API経由で変更不能な属性
- id
- userName
- meta
- eduPersonPrincipalNames

## read_file
- ファイルを読み込みユーザーデータとして扱いやすいように変換する
- ファイルサイズの上限は定数MAX_FILE_UPLOADとしてconstファイルに定義する

#### シグネチャ
```python[bulk.py]
def read_file(temporary_id:str) -> list[UserDetail]:
```

#### 引数
| 名前         | 型             | 説明                                 |
| ------------ | -------------- | ------------------------------------ |
| temporary_id | pydantic.UUID7 | 仮アップロードされたファイルの識別子 |

#### 戻り値
| 型               | 説明                         |
| ---------------- | ---------------------------- |
| list[UserDetail] | インポートするユーザーデータ |

#### 処理内容
1. temporary_idをもとにDBからfile_pathを取得
2. file_pathからファイルを取得
3. ファイルが存在しない場合，ResourceNotFoundを送出
4. 形式がcsv,tsv,excelと異なる場合，ファイルサイズが上限以上の場合はResourceInvalidを送出
5. ファイルを一人分（idが変わる行まで）読み込む
6. ファイルの内容を用いてUserDetailオブジェクトを作成
7. 最後の行まで繰り返す
8. UserDetailのリストを返却する

## get_validate_result
upload_historyテーブルから結果を取得する

#### シグネチャ
```python[bulk.py]
def get_validate_result(history_id:pydantic.UUID7) -> ValidateSummary:
```

#### 引数
| 名前       | 型             | 説明   |
| ---------- | -------------- | ------ |
| history_id | pydantic.UUID7 | 履歴ID |

#### 戻り値
| 型              | 説明           |
| --------------- | -------------- |
| ValidateSummary | インポート結果 |

#### 処理内容
1. upload_historyテーブルとfilesテーブルを結合しidがhistory_idと一致するデータを取得する
2. 取得したデータからValidateSummaryを作成して返却

## update_users
- インポートを実行する
- celeryのtaskで実行する

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前          | 型             | 説明                                                       |
| ------------- | -------------- | ---------------------------------------------------------- |
| task_id       | str            | バリデーションタスクのID                                   |
| repository_id | str            | 選択されたリポジトリのID                                   |
| temporary_id  | pydantic.UUID7 | 仮アップロードされたファイルの識別子                       |
| delete_users  | list[str]      | 削除(リポジトリ内のグループから除外)するユーザーのIDリスト |

#### 戻り値
| 型             | 説明   |
| -------------- | ------ |
| pydantic.UUID7 | 履歴ID |

#### 処理内容
1. services.bulk::build_bulk_operations()を実行
2. [`save_file`](#save_file)でファイルを保存する
3. UUIDv7の履歴IDを作成する
4. 履歴IDとファイルID，operator,timestamp,public=True,status="p"でupload_historyテーブルに保存する
5. Bulkオブジェクトをリクエストボディとして[`client.bulk::post`](../06.clients/06.bulk.md#post)を呼び出す
6. レスポンスを解析しエラーがあればlist[CheckResult]のstatusをerrorに変更しupload_historyテーブルのresultに保存
7. 履歴IDを返却

## get_import_result
upload_historyテーブルから結果を取得する

#### シグネチャ
```python[bulk.py]
def get_result(history_id:pydantic.UUID7) -> ResultSummary:
```

#### 引数
| 名前       | 型             | 説明   |
| ---------- | -------------- | ------ |
| history_id | pydantic.UUID7 | 履歴ID |

#### 戻り値
| 型            | 説明           |
| ------------- | -------------- |
| ResultSummary | インポート結果 |

#### 処理内容
1. upload_historyテーブルとfilesテーブルを結合しidがhistory_idと一致するデータを取得する
2. 取得したデータからResultSummaryを作成して返却

## delete_temporary_file
一時アップロードされたファイルを削除する

#### デコレータ
- `@shared_task` : アプリケーションインスタンスに依存せずタスク定義を行うために用いる

#### 引数
| 名前         | 型             | 説明                               |
| ------------ | -------------- | ---------------------------------- |
| temporary_id | pydantic.UUID7 | アップロードされたファイルの識別子 |

#### 処理内容
1. temporary_idをもとにfilesテーブルからファイルパスを取得
2. 該当するファイルが存在するか確認
3. 存在する場合ファイルを削除する
