---
title: services.token
description: 当システムのアクセストークン管理に関するビジネスロジックを提供する。
---

## get_oauth_token
データベースから当システムに紐づく SP のアクセストークン文字列を取得する機能を提供する。

#### シグネチャ
```python[token.py]
def get_oauth_token() -> str:
```

#### 戻り値
| 型  | 説明                   |
| --- | ---------------------- |
| str | アクセストークン文字列 |

#### エラー

| 型                                                            | 説明                                                   |
| ------------------------------------------------------------- | ------------------------------------------------------ |
| [DatabaseError](../02.foundation/07.exc.md#databaseerror)     | データベース操作で予期しないエラーが発生した場合。     |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror) | アクセストークンが存在しない、または読み取れない場合。 |

#### 処理内容
1. [`service_settings.get_oauth_token`](./06.service_settings.md#get_oauth_token) を呼び出し、データベースからアクセストークン情報を取得する。
2. レコードが存在しない場合は [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror) を送出する。
3. 取得したアクセストークン情報からアクセストークン文字列を戻り値として返す。


## get_client_secret
データベースから当システムに紐づく SP のクライアントシークレット文字列を取得する機能を提供する。

#### シグネチャ
```python[token.py]
def get_client_secret() -> str:
```

#### 戻り値
| 型  | 説明                           |
| --- | ------------------------------ |
| str | クライアントシークレット文字列 |

#### エラー

| 型                                                              | 説明                                                       |
| --------------------------------------------------------------- | ---------------------------------------------------------- |
| [DatabaseError](../02.foundation/07.exc.md#databaseerror)       | データベース操作で予期しないエラーが発生した場合。         |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror) | クライアント認証情報が存在しない、または読み取れない場合。 |

#### 処理内容
1. [`service_settings.get_client_credentials`](./06.service_settings.md#get_client_credentials) を呼び出し、データベースからクライアント認証情報を取得する。
2. レコードが存在しない場合は [`CredentialsError`](../02.foundation/07.exc.md#credentialserror) を送出する。
3. 取得したクライアント認証情報からクライアントシークレット文字列を戻り値として返す。


## prepare_issuing_url
当システムに紐づく SP のアクセストークン発行用 URL を準備する機能を提供する。

#### シグネチャ
```python[token.py]
def prepare_issuing_url() -> str:
```

#### 戻り値

| 型  | 説明                       |
| --- | -------------------------- |
| str | アクセストークン発行用 URL |

#### エラー

| 型                                                                | 説明                                                  |
| ----------------------------------------------------------------- | ----------------------------------------------------- |
| [DatabaseError](../02.foundation/07.exc.md#databaseerror)         | データベース操作で予期しないエラーが発生した場合。    |
| [CertificatesError](../02.foundation/07.exc.md#certificateserror) | SP の証明書情報の取得あるいは新規発行に失敗した場合。 |

#### 処理内容
1. サーバー設定 [`config.SP`](../02.foundation/02.config.md#spconfig) から `entity_id` を取得する。
2. [`service_settings.get_client_credentials`](./06.service_settings.md#get_client_credentials) を呼び出し、データベースからクライアント認証情報を取得する。
3. クライアント認証情報が存在しない場合、 [`clients.auth.issue_client_credentials`](../06.clients/01.auth.md#issue_client_credentials) 
   を呼び出し、 mAP Core Authorization Server からクライアント認証情報を発行・取得する。
4. 取得したクライアント認証情報を [`service_settings.save_client_credentials`](./06.service_settings.md#save_client_credentials) を呼び出し、データベースに保存する。
5. リダイレクト URL を生成する。エンドポイント [`api.callback.auth_code`](../04.api/06.callback.md#auth_code)
   に対応するスキーマとホスト名を含む完全な URL を `flask.url_for` を使用して取得する。
6. アクセストークン発行用 URL を生成する。
    - ベース URL として、サーバー設定値 [`config.MAP_CORE`](../02.foundation/02.config.md#mapcoreconfig) の `base_url` を使用する。
    - エンドポイントは [`MAP_OAUTH_AUTHORIZE_ENDPOINT`](../02.foundation/03.const.md#map_oauth_authorize_endpoint) を使用する。
    - クエリパラメータとして以下を付与する。
      | 名前          | 値                                            |
      | ------------- | --------------------------------------------- |
      | response_type | `"code"`                                      |
      | client_id     | ステップ 2 または 3 で取得したクライアント ID |
      | redirect_uri  | ステップ 5 で生成した URL                     |


## issue_access_token
当システムに紐づく SP のアクセストークンを mAP Core Authorization Server から発行・取得する機能を提供する。

#### シグネチャ
```python[token.py]
def issue_access_token(code: str) -> str:
```

#### 引数

| 名前 | 型  | 説明             |
| ---- | --- | ---------------- |
| code | str | 認可コード文字列 |

#### 戻り値

| 型  | 説明                   |
| --- | ---------------------- |
| str | アクセストークン文字列 |

#### エラー

| 型                                                              | 説明                                                       |
| --------------------------------------------------------------- | ---------------------------------------------------------- |
| [DatabaseError](../02.foundation/07.exc.md#databaseerror)       | データベース操作で予期しないエラーが発生した場合。         |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror) | クライアント認証情報が存在しない、または読み取れない場合。 |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)   | アクセストークンの発行に失敗した場合。                     |

#### 処理内容
1. [`service_settings.get_client_credentials`](./06.service_settings.md#get_client_credentials) を呼び出し、データベースからクライアント認証情報を取得する。
2. クライアント認証情報が存在しない場合は [`CredentialsError`](../02.foundation/07.exc.md#credentialserror) を送出する。
3. [`clients.auth.issue_oauth_token`](../06.clients/01.auth.md#issue_oauth_token) を呼び出し、引数 `code` を使用してアクセストークンの発行・取得を試みる。
4. アクセストークンの発行に失敗した場合は [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror) を送出する。
5. [`service_settings.save_oauth_token`](./06.service_settings.md#save_oauth_token) を呼び出し、取得したアクセストークン情報をデータベースに保存する。
6. 取得したアクセストークン文字列を戻り値として返す。


## refresh_access_token
当システムに紐づく SP のアクセストークンをリフレッシュする機能を提供する。

#### シグネチャ
```python[token.py]
def refresh_access_token() -> str:
```

#### 戻り値

| 型  | 説明                                   |
| --- | -------------------------------------- |
| str | リフレッシュ後のアクセストークン文字列 |

#### エラー

| 型                                                              | 説明                                                       |
| --------------------------------------------------------------- | ---------------------------------------------------------- |
| [DatabaseError](../02.foundation/07.exc.md#databaseerror)       | データベース操作で予期しないエラーが発生した場合。         |
| [CredentialsError](../02.foundation/07.exc.md#credentialserror) | クライアント認証情報が存在しない、または読み取れない場合。 |
| [OAuthTokenError](../02.foundation/07.exc.md#oauthtokenerror)   | アクセストークンのリフレッシュに失敗した場合。             |

#### 処理内容
1. [`service_settings.get_oauth_token`](./06.service_settings.md#get_oauth_token) を呼び出し、データベースからアクセストークン情報を取得する。
2. アクセストークン情報が存在しない場合は [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror) を送出する。
3. [`service_settings.get_client_credentials`](./06.service_settings.md#get_client_credentials) を呼び出し、データベースからクライアント認証情報を取得する。
4. クライアント認証情報が存在しない場合は [`CredentialsError`](../02.foundation/07.exc.md#credentialserror) を送出する。
5. [`clients.auth.refresh_oauth_token`](../06.clients/01.auth.md#refresh_oauth_token) を呼び出し、アクセストークンのリフレッシュを試みる。
6. アクセストークンのリフレッシュに失敗した場合は [`OAuthTokenError`](../02.foundation/07.exc.md#oauthtokenerror) を送出する。
7. [`service_settings.save_oauth_token`](./06.service_settings.md#save_oauth_token) を呼び出し、取得したアクセストークン情報をデータベースに保存する。
8. 取得したアクセストークン文字列を戻り値として返す。
